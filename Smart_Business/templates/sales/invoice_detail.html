{% extends 'base.html' %}

{% block title %}
  Invoice {{ invoice.invoice_no }} - SmartBiz
{% endblock %}

{% block content %}
  <div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h4 class="mb-1">Invoice {{ invoice.invoice_no }}</h4>
        <small class="text-muted">Date: {{ invoice.date }} | Created: {{ invoice.created_at|date:'Y-m-d H:i' }}</small>
      </div>
      <div>
        <a class="btn btn-outline-primary btn-sm" href="{% url 'sales:invoice_edit' invoice.pk %}">Edit</a>
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'sales:invoice_list' %}">Back</a>
      </div>
    </div>

    <!-- Business / Customer / Status -->
    <div class="card p-3 mb-3">
      <div class="row">
        <div class="col-md-6">
          <h6 class="text-uppercase text-muted mb-2">Business</h6>
          <p class="mb-1">{{ business.name }}</p>
        </div>
        <div class="col-md-6">
          <h6 class="text-uppercase text-muted mb-2">Customer</h6>
          <p class="mb-1">
            {% if invoice.customer %}
              {{ invoice.customer.name }}<br />
              {% if invoice.customer.phone %}
                <small>ðŸ“ž {{ invoice.customer.phone }}</small><br />
              {% endif %}
              {% if invoice.customer.email %}
                <small>ðŸ“§ {{ invoice.customer.email }}</small>
              {% endif %}
            {% else %}
              <span class="text-muted">No customer selected</span>
            {% endif %}
          </p>
        </div>
      </div>

      <hr />

      <div class="row">
        <div class="col-md-4 mb-2">
          <strong>Status:</strong>
          {% if invoice.status == invoice.STATUS_PAID %}
            <span class="badge bg-success ms-1">{{ invoice.get_status_display }}</span>
          {% elif invoice.status == invoice.STATUS_PARTIAL %}
            <span class="badge bg-warning text-dark ms-1">{{ invoice.get_status_display }}</span>
          {% else %}
            <span class="badge bg-danger ms-1">{{ invoice.get_status_display }}</span>
          {% endif %}
        </div>
        <div class="col-md-8 mb-2">
          <strong>Notes:</strong>
          {% if invoice.notes %}
            <div class="mt-1">{{ invoice.notes|linebreaksbr }}</div>
          {% else %}
            <span class="text-muted">No notes</span>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Line items -->
    <div class="card mb-3 p-3">
      <h6 class="mb-3">Invoice Items</h6>
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Product</th>
              <th class="text-end">UOM</th> {# will show "0.5 Ltr", "1 Kg" #}
              <th class="text-end">Qty</th>
              <th class="text-end">Unit Price</th>
              <th class="text-end">GST %</th>
              <th class="text-end">Line (before tax)</th>
              <th class="text-end">Tax Amt</th>
              <th class="text-end">CGST</th>
              <th class="text-end">SGST</th>
            </tr>
          </thead>
          <tbody>
            {% for it in invoice.items.all %}
              <tr>
                <td>{{ it.product.name }}</td>

                {# ðŸ”¹ UOM cell: "0.5 Ltr", "1 Kg" #}
                <td class="text-end">
                  <strong>{{ it.uom|floatformat:'-2' }}</strong>
                  {% if it.product.base_unit %}
                    <span class="text-muted">{{ it.product.base_unit }}</span>
                  {% endif %}
                </td>

                {# Qty: only numbers (1,2,3...) #}
                <td class="text-end">{{ it.quantity|floatformat:'-2' }}</td>

                <td class="text-end">â‚¹{{ it.unit_price }}</td>
                <td class="text-end">{{ it.tax_percent }}%</td>
                <td class="text-end">â‚¹{{ it.line_total }}</td>
                <td class="text-end">â‚¹{{ it.tax_amount }}</td>
                <td class="text-end">â‚¹{{ it.cgst_amount }}</td>
                <td class="text-end">â‚¹{{ it.sgst_amount }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="9" class="text-center text-muted py-3">No items added to this invoice.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="row">
      <!-- Payments -->
      <div class="col-md-6 mb-3">
        <div class="card h-100 p-3">
          <h6 class="mb-3">Payments</h6>

          {% if payments %}
            <ul class="list-group list-group-flush mb-2">
              {% for pay in payments %}
                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                  <div>
                    â‚¹{{ pay.amount }}
                    {% if pay.method %}
                      <small class="text-muted">({{ pay.method }})</small>
                    {% endif %}
                    {% if pay.notes %}
                      <br /><small class="text-muted">{{ pay.notes }}</small>
                    {% endif %}
                  </div>
                  <span class="text-muted small">{{ pay.payment_date|date:'Y-m-d H:i' }}</span>
                </li>
              {% endfor %}
            </ul>

            <div>
              <strong>Current Status:</strong>
              {% if invoice.status == invoice.STATUS_PAID %}
                <span class="badge bg-success ms-1">{{ invoice.get_status_display }}</span>
              {% elif invoice.status == invoice.STATUS_PARTIAL %}
                <span class="badge bg-warning ms-1">{{ invoice.get_status_display }}</span>
              {% else %}
                <span class="badge bg-danger text-dark ms-1">{{ invoice.get_status_display }}</span>
              {% endif %}
            </div>
          {% else %}
            <div>
              <strong>Current Status:</strong>
              {% if invoice.status == invoice.STATUS_PAID %}
                <span class="badge bg-success ms-1">{{ invoice.get_status_display }}</span>
              {% elif invoice.status == invoice.STATUS_PARTIAL %}
                <span class="badge bg-warning text-dark ms-1">{{ invoice.get_status_display }}</span>
              {% else %}
                <span class="badge bg-danger ms-1">{{ invoice.get_status_display }}</span>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Totals summary -->
      <div class="col-md-6 mb-3">
        <div class="card h-100 p-3">
          <h6 class="mb-3">Summary</h6>
          <table class="table table-sm mb-0">
            <tr>
              <td>Subtotal (taxable):</td>
              <td class="text-end">â‚¹{{ invoice.subtotal_taxable }}</td>
            </tr>
            <tr>
              <td>Subtotal (exempt):</td>
              <td class="text-end">â‚¹{{ invoice.subtotal_exempt }}</td>
            </tr>
            <tr>
              <td>CGST (sum):</td>
              <td class="text-end">â‚¹{{ invoice.cgst_total }}</td>
            </tr>
            <tr>
              <td>SGST (sum):</td>
              <td class="text-end">â‚¹{{ invoice.sgst_total }}</td>
            </tr>
            <tr class="table-light">
              <th>Total (with tax):</th>
              <th class="text-end">â‚¹{{ invoice.total }}</th>
            </tr>
            <tr>
              <td>Amount Paid:</td>
              <td class="text-end">â‚¹{{ invoice.amount_paid }}</td>
            </tr>
            <tr>
              <td>Remaining:</td>
              <td class="text-end">â‚¹{{ invoice.remaining_amount }}</td>
            </tr>
            <tr>
              <td>Status:</td>
              <td class="text-end">
                {% if invoice.status == invoice.STATUS_PAID %}
                  <span class="badge bg-success">{{ invoice.get_status_display }}</span>
                {% elif invoice.status == invoice.STATUS_PARTIAL %}
                  <span class="badge bg-warning text-dark">{{ invoice.get_status_display }}</span>
                {% else %}
                  <span class="badge bg-danger">{{ invoice.get_status_display }}</span>
                {% endif %}
              </td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
