{% extends 'base.html' %}
{% load static %}
{% block title %}Invoice List{% endblock %}

{% block content %}
<div class="card p-3">
  <h4 class="mb-3">Invoices for {{ business.name }}</h4><hr>

  <!-- Filters form (GET) with buttons + New Invoice on the right -->
  <form id="filtersForm" class="row g-2 align-items-center mb-3" method="get">
    <div class="col-md-4">
      <input type="text" name="q" value="{{ request.GET.q|default:'' }}" class="form-control" placeholder="Search customer name or invoice no">
    </div>

    <div class="col-auto">
      <input type="date" name="date_from" value="{{ request.GET.date_from|default:'' }}" class="form-control">
    </div>
    <div class="col-auto">
      <input type="date" name="date_to" value="{{ request.GET.date_to|default:'' }}" class="form-control">
    </div>

    <div class="col-auto">
      <select name="status" class="form-select">
        <option value="">All status</option>
        <option value="paid" {% if request.GET.status == 'paid' %}selected{% endif %}>Paid</option>
        <option value="partial" {% if request.GET.status == 'partial' %}selected{% endif %}>Partial</option>
        <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
      </select>
    </div>

    <div class="col-auto">
      <select name="per_page" id="per_page" class="form-select">
        <option value="5" {% if request.GET.per_page == '5' %}selected{% endif %}>5</option>
        <option value="25" {% if request.GET.per_page == '25' or not request.GET.per_page %}selected{% endif %}>25</option>
        <option value="50" {% if request.GET.per_page == '50' %}selected{% endif %}>50</option>
        <option value="100" {% if request.GET.per_page == '100' %}selected{% endif %}>100</option>
      </select>
    </div>

    {# spacer pushes buttons to the right #}
    <div class="col"></div>

    <div class="col-auto d-flex gap-2">
      <button type="submit" class="btn btn-primary">Filter</button>
      <a href="{% url 'sales:invoice_list' %}" class="btn btn-outline-secondary">Reset</a>
    </div>
  </form>
  <hr>

  <div class="d-flex justify-content-end mb-2">
      <a href="{% url 'sales:invoice_create' %}" class="btn btn-success">+ New Invoice</a>
  </div>
  <hr>

  <!-- Selection toolbar -->
  <div id="selectionToolbar" class="d-none mb-2">
    <div class="d-flex align-items-center gap-2">
      <small id="selectedCount">0 selected</small>
      <button id="exportSelectedBtn" class="btn btn-sm btn-outline-success">Export Selected</button>
      <button id="clearSelectedBtn" class="btn btn-sm btn-outline-secondary">Clear</button>
    </div>
  </div>

  <!-- Table -->
  <div class="table-responsive position-relative">
    <table class="table table-bordered" id="invoicesTable">
      <thead>
        <tr>
          <th style="width:36px;"><input id="selectAll" type="checkbox"></th>
          <th>Invoice No</th>
          <th>Date</th>
          <th>Customer</th>
          <th>Total</th>
          <th>Paid</th>
          <th>Status</th>
          <th>Remaining</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for inv in invoices %}
          {# data-products is a JSON array: [{"name":"Prod","qty":2}, ...] #}
          <tr class="invoice-row" data-invoice-id="{{ inv.pk }}"
              data-products='[{% for it in inv.items.all %}{"name":"{{ it.product.name|escapejs }}","qty":{{ it.quantity }}}{% if not forloop.last %},{% endif %}{% endfor %}]'>
            <td><input class="rowCheckbox" type="checkbox" value="{{ inv.pk }}"></td>
            <td class="invoice-no-cell">{{ inv.invoice_no }}</td>
            <td>{{ inv.date }}</td>

            {# customer cell — add class to enable tooltip on hover #}
            <td class="customer-cell show-tooltip">{{ inv.customer }}</td>

            <td>{{ inv.total }}</td>
            <td>{{ inv.amount_paid }}</td>
            <td>
              {% if inv.status == 'paid' %}
                <span class="badge bg-success">Paid</span>
              {% elif inv.status == 'partial' %}
                <span class="badge bg-warning text-dark">Partial</span>
              {% elif inv.status == 'pending' %}
                <span class="badge bg-danger">Pending</span>
              {% else %}
                <span class="badge bg-secondary">{{ inv.status }}</span>
              {% endif %}
            </td>
            <td>{{ inv.remaining_amount }}</td>
            <td>
              {# give View button a specific class for tooltip binding; keep href to detail view #}
              <a class="btn btn-sm btn-info view-btn show-tooltip" href="{% url 'sales:invoice_detail' inv.pk %}" title="View invoice">View</a>
              <a class="btn btn-sm btn-warning" href="{% url 'sales:invoice_edit' inv.pk %}">Edit</a>
              <form action="{% url 'sales:invoice_delete' inv.pk %}" method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-danger"
                        onclick="return confirm('Are you sure you want to delete Invoice {{ inv.invoice_no }}?');">Delete</button>
              </form>
              <a class="btn btn-sm btn-secondary" href="{% url 'sales:invoice_email' inv.pk %}">Email</a>
              <a href="{% url 'sales:invoice_pdf' inv.pk %}"
                 class="btn btn-sm btn-outline-danger"
                 target="_blank">PDF</a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="9" class="text-center">No invoices found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination controls (JS-driven links preserve GET params) -->
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <p class="mb-0">Showing {{ page_obj.start_index }} - {{ page_obj.end_index }} of {{ page_obj.paginator.count }}</p>
    </div>
    <nav aria-label="Page navigation">
      <ul class="pagination mb-0" id="paginationList">
        {% if page_obj.has_previous %}
          <li class="page-item"><a href="#" class="page-link page-link-js" data-page="{{ page_obj.previous_page_number }}">Previous</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
          {% if num == page_obj.number %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% elif num <= page_obj.number|add:'2' and num >= page_obj.number|add:'-2' %}
            <li class="page-item"><a href="#" class="page-link page-link-js" data-page="{{ num }}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <li class="page-item"><a href="#" class="page-link page-link-js" data-page="{{ page_obj.next_page_number }}">Next</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
      </ul>
    </nav>
  </div>
</div>

<!-- Tooltip element (hidden by default) -->
<div id="invoiceTooltip" class="card shadow-sm p-2" style="position:fixed; display:none; z-index:2000; max-width:360px; pointer-events:none;">
  <strong>Products</strong>
  <ul id="tooltipList" class="mb-0" style="padding-left:14px;"></ul>
</div>

<style>
  #selectionToolbar { background:#f8f9fa; padding:8px; border-radius:6px; }
  /* Slight hover cursor on show-tooltip elements so it is discoverable */
  .show-tooltip { cursor: pointer; }
</style>

<script>
// helper to build current GET string while preserving existing filters (except 'page')
function buildQueryWith(params) {
  const urlParams = new URLSearchParams(window.location.search);
  for (const k in params) {
    if (params[k] === null) urlParams.delete(k);
    else urlParams.set(k, params[k]);
  }
  return urlParams.toString();
}

document.addEventListener('DOMContentLoaded', function() {
  // Selection toolbar logic (unchanged)
  const selectAll = document.getElementById('selectAll');
  const rowCheckboxes = Array.from(document.querySelectorAll('.rowCheckbox'));
  const toolbar = document.getElementById('selectionToolbar');
  const selectedCountEl = document.getElementById('selectedCount');
  const exportBtn = document.getElementById('exportSelectedBtn');
  const clearBtn = document.getElementById('clearSelectedBtn');

  function updateToolbar() {
    const checked = rowCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
    const count = checked.length;
    if (count > 0) {
      toolbar.classList.remove('d-none');
      selectedCountEl.textContent = `${count} selected`;
      // export base (ensure you have this URL name in your urls)
      const base = "{% url 'sales:invoice_export' %}";
      exportBtn.onclick = function(e) {
        e.preventDefault();
        const ids = checked.join(',');
        const query = buildQueryWith({'ids': ids});
        window.open(base + '?' + query, '_blank');
      };
    } else {
      toolbar.classList.add('d-none');
      selectedCountEl.textContent = '0 selected';
      exportBtn.onclick = null;
    }
  }

  if (selectAll) {
    selectAll.addEventListener('change', function() {
      rowCheckboxes.forEach(cb => cb.checked = selectAll.checked);
      updateToolbar();
    });
  }

  rowCheckboxes.forEach(cb => {
    cb.addEventListener('change', function() {
      if (!this.checked && selectAll) selectAll.checked = false;
      else if (selectAll && rowCheckboxes.every(c => c.checked)) selectAll.checked = true;
      updateToolbar();
    });
  });

  clearBtn.addEventListener('click', function() {
    rowCheckboxes.forEach(cb => cb.checked = false);
    if (selectAll) selectAll.checked = false;
    updateToolbar();
  });

  // Tooltip logic: only for elements with class 'show-tooltip' (customer cell and view button)
  const tooltip = document.getElementById('invoiceTooltip');
  const tooltipList = document.getElementById('tooltipList');

  function showTooltipForElement(el, event) {
    // find nearest row and read its data-products attribute
    const row = el.closest('.invoice-row');
    if (!row) return;
    const raw = row.getAttribute('data-products') || '[]';
    let products = [];
    try { products = JSON.parse(raw); } catch(err){ products = []; }

    // build list
    tooltipList.innerHTML = '';
    if (products.length === 0) {
      tooltipList.innerHTML = '<li><em>No items</em></li>';
    } else {
      products.forEach(p => {
        const li = document.createElement('li');
        li.style.marginBottom = '6px';
        li.textContent = `${p.name} — ${p.qty}`;
        tooltipList.appendChild(li);
      });
    }

    // position tooltip near cursor (but keep it on-screen)
    tooltip.style.display = 'block';
    const pageX = event.pageX;
    const pageY = event.pageY;
    // basic positioning with small offset
    let left = pageX + 12;
    let top = pageY + 12;

    // keep within viewport
    const maxRight = window.scrollX + window.innerWidth - 20;
    const tooltipRect = tooltip.getBoundingClientRect();
    if (left + tooltipRect.width > maxRight) left = pageX - tooltipRect.width - 12;
    if (top + tooltipRect.height > window.scrollY + window.innerHeight - 20) top = pageY - tooltipRect.height - 12;

    tooltip.style.left = left + 'px';
    tooltip.style.top = top + 'px';
  }

  function hideTooltip() {
    tooltip.style.display = 'none';
  }

  // Attach events to show-tooltip elements (View button and customer cell)
  document.querySelectorAll('.show-tooltip').forEach(el => {
    el.addEventListener('mouseenter', function(e) {
      showTooltipForElement(el, e);
    });
    el.addEventListener('mousemove', function(e) {
      // reposition on mouse move
      showTooltipForElement(el, e);
    });
    el.addEventListener('mouseleave', function() {
      hideTooltip();
    });
  });

  // ensure filter form keeps per_page selection and triggers page reset when per_page changes
  const perPageEl = document.getElementById('per_page');
  if (perPageEl) {
    perPageEl.addEventListener('change', function() {
      const f = document.getElementById('filtersForm');
      const pageInput = document.createElement('input');
      pageInput.type = 'hidden'; pageInput.name = 'page'; pageInput.value = '1';
      f.appendChild(pageInput);
      f.submit();
    });
  }

  // Pagination links: build URL preserving existing GET params
  document.querySelectorAll('.page-link-js').forEach(a => {
    a.addEventListener('click', function(e) {
      e.preventDefault();
      const page = this.dataset.page;
      const params = new URLSearchParams(window.location.search);
      params.set('page', page);
      window.location.search = params.toString();
    });
  });

});
</script>
{% endblock %}
