{% extends 'base.html' %}
{% load static %}
{% block title %}
  Create / Edit Invoice - SmartBiz
{% endblock %}

{% block content %}
  <div class="container py-4">
    <h3>
      {% if editing %}
        Edit Invoice
      {% else %}
        Create Invoice
      {% endif %}
    </h3>

    <form method="post" id="invoice-form">
      {% csrf_token %}
      {{ form.non_field_errors }}

      <!-- Display form errors -->
      {% if form.errors %}
        <div class="alert alert-danger">
          <strong>Please correct the errors below:</strong>
          <ul>
            {% for field, errors in form.errors.items %}
              {% for error in errors %}
                <li>{{ field }}: {{ error }}</li>
              {% endfor %}
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      <div class="row mb-3">
        <div class="col-md-4">
          {{ form.business }}
          <label class="form-label">Business</label>
          <div class="form-control-plaintext">
            {% if business %}
              <strong>{{ business.name }}</strong>
            {% else %}
              &mdash;
            {% endif %}
          </div>
        </div>

        <div class="col-md-4">
          <label for="{{ form.customer.id_for_label }}" class="form-label">Customer</label>
          {{ form.customer }}
          {% for err in form.customer.errors %}
            <div class="text-danger small">{{ err }}</div>
          {% endfor %}

          <div class="mt-1">
            <a href="{% url 'sales:customer_create' %}" class="btn btn-sm btn-outline-primary" target="_blank">+ Add Customer</a>
          </div>

          <!-- Show selected customer's contact details -->
          <div id="customer-details" class="mt-2 p-2 border rounded bg-light" style="display:none">
            <strong id="cust-name"></strong><br />
            <span id="cust-phone"></span><br />
            <span id="cust-email"></span><br />
            <span id="cust-address"></span>
          </div>
        </div>

        <div class="col-md-2">
          <label for="{{ form.invoice_no.id_for_label }}" class="form-label">{{ form.invoice_no.label }}</label>
          {{ form.invoice_no }}
          {% for err in form.invoice_no.errors %}
            <div class="text-danger small">{{ err }}</div>
          {% endfor %}
        </div>

        <div class="col-md-2">
          <label for="{{ form.date.id_for_label }}" class="form-label">{{ form.date.label }}</label>
          {{ form.date }}
          {% for err in form.date.errors %}
            <div class="text-danger small">{{ err }}</div>
          {% endfor %}
        </div>
      </div>

      <h5>Items / Products</h5>

      <!-- Display formset errors -->
      {% if formset.errors %}
        <div class="alert alert-warning">
          <strong>Please check item errors:</strong>
          {% for form in formset %}
            {% if form.errors %}
              Item {{ forloop.counter }}:{% for field, errors in form.errors.items %}
                {{ field }}: {{ errors|join:', ' }}
              {% endfor %}
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}

      <table class="table table-bordered table-fixed" id="items-table">
        <thead>
          <tr>
            <th>Product</th>
            <th style="width:100px">UOM</th>  {# ðŸ”¹ added UOM column #}
            <th style="width:90px">Qty</th>
            <th style="width:120px">Unit Price</th>
            <th style="width:110px">GST %</th>
            <th style="width:120px">Line Total</th>
            <th style="width:80px">Remove</th>
          </tr>
        </thead>
        <tbody id="items-tbody">
          {{ formset.management_form }}

          {# ðŸ”¹ Render ALL forms (including empty ones) #}
          {% for f in formset %}
            <tr class="item-row">
              <td>
                {{ f.id }}
                {{ f.product }}
                {% for err in f.product.errors %}
                  <div class="text-danger small">{{ err }}</div>
                {% endfor %}
              </td>
              <td>
                {{ f.uom }}
                {% for err in f.uom.errors %}
                  <div class="text-danger small">{{ err }}</div>
                {% endfor %}
              </td>
              <td>
                {{ f.quantity }}
                {% for err in f.quantity.errors %}
                  <div class="text-danger small">{{ err }}</div>
                {% endfor %}
              </td>
              <td>
                {{ f.unit_price }}
                {% for err in f.unit_price.errors %}
                  <div class="text-danger small">{{ err }}</div>
                {% endfor %}
              </td>
              <td>
                {{ f.tax_percent }}
                {% for err in f.tax_percent.errors %}
                  <div class="text-danger small">{{ err }}</div>
                {% endfor %}
              </td>
              <td>
                <input type="text" readonly class="form-control line-total" value="0.00" />
              </td>
              <td>
                <span class="d-none">{{ f.DELETE }}</span>
                <button type="button" class="btn btn-sm btn-danger remove-row">Remove</button>
              </td>
            </tr>
          {% endfor %}

          {# ðŸ”¹ Hidden template row from empty_form (for JS "Add Item") #}
          <tr id="empty-form-row" class="item-row d-none">
            {% with f=formset.empty_form %}
              <td>{{ f.id }} {{ f.product }}</td>
              <td>{{ f.uom }}</td>  {# ðŸ”¹ UOM in empty form row #}
              <td>{{ f.quantity }}</td>
              <td>{{ f.unit_price }}</td>
              <td>{{ f.tax_percent }}</td>
              <td>
                <input type="text" readonly class="form-control line-total" value="0.00" />
              </td>
              <td>
                <span class="d-none">{{ f.DELETE }}</span>
                <button type="button" class="btn btn-sm btn-danger remove-row">Remove</button>
              </td>
            {% endwith %}
          </tr>
        </tbody>
      </table>

      <button type="button" id="add-row" class="btn btn-outline-primary btn-sm mb-3">+ Add Item</button>

      <div class="row">
        <div class="col-md-6">
          <!-- Amount Paid -->
          <div class="mb-3">
            <label for="{{ form.amount_paid.id_for_label }}" class="form-label">{{ form.amount_paid.label }}</label>
            {{ form.amount_paid }}
            {% for err in form.amount_paid.errors %}
              <div class="text-danger small">{{ err }}</div>
            {% endfor %}
          </div>

          <!-- Status directly below Amount Paid -->
          <div class="mb-3">
            <label for="{{ form.status.id_for_label }}" class="form-label">{{ form.status.label }}</label>
            {{ form.status }}
            {% for err in form.status.errors %}
              <div class="text-danger small">{{ err }}</div>
            {% endfor %}
          </div>

          <div class="mb-3">
            <label for="{{ form.notes.id_for_label }}" class="form-label">{{ form.notes.label }}</label>
            {{ form.notes }}
            {% for err in form.notes.errors %}
              <div class="text-danger small">{{ err }}</div>
            {% endfor %}
          </div>
        </div>

        <div class="col-md-6">
          <table class="table">
            <tr>
              <td>Subtotal (taxable):</td>
              <td class="text-end">
                <span id="subtotal-taxable">0.00</span>
              </td>
            </tr>
            <tr>
              <td>Subtotal (exempt):</td>
              <td class="text-end">
                <span id="subtotal-exempt">0.00</span>
              </td>
            </tr>
            <tr>
              <td>CGST (sum):</td>
              <td class="text-end">
                <span id="cgst-total">0.00</span>
              </td>
            </tr>
            <tr>
              <td>SGST (sum):</td>
              <td class="text-end">
                <span id="sgst-total">0.00</span>
              </td>
            </tr>
            <tr>
              <th>Total:</th>
              <th class="text-end">
                <span id="grand-total">0.00</span>
              </th>
            </tr>
            <tr>
              <td>Amount Paid:</td>
              <td class="text-end">
                <span id="display-amount-paid">0.00</span>
              </td>
            </tr>
            <tr>
              <th>Remaining:</th>
              <th class="text-end">
                <span id="remaining-amount">0.00</span>
              </th>
            </tr>
          </table>
        </div>
      </div>

      <div class="d-flex justify-content-end">
        <a class="btn btn-secondary me-2" href="{% url 'sales:invoice_list' %}">Cancel</a>
        <button class="btn btn-primary" type="submit">Save Invoice</button>
      </div>
    </form>
  </div>

  <script>
  // Safe default if products_for_js is not passed (still used for price auto-fill)
  const PRODUCTS = {{ products_for_js|default:"[]"|safe }};

  (function(){

    function toDecimal(v){
      if (v === null || typeof v === "undefined" || v === "") return 0;
      const s = String(v).replace(/,/g, '');
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : 0;
    }

    function round2(v){
      return (Math.round((Number(v) + Number.EPSILON) * 100) / 100).toFixed(2);
    }

    function getFormsetInfo() {
      // input like name="invoiceitem_set-TOTAL_FORMS"
      const totalFormsEl = document.querySelector('input[name$="-TOTAL_FORMS"]');
      if (!totalFormsEl) return null;
      return { totalFormsEl };
    }

    function recalcAll(){
      let subtotal_taxable = 0, subtotal_exempt = 0, cgst_total = 0, sgst_total = 0, grand_total = 0;

      const rows = document.querySelectorAll('#items-table tbody tr.item-row');
      rows.forEach(function(row){
        // Skip rows that are marked for deletion (DELETE checkbox checked)
        const deleteCheckbox = row.querySelector('input[name$="-DELETE"]');
        if (deleteCheckbox && deleteCheckbox.checked) {
          return;
        }

        const uomInput  = row.querySelector('input[name$="-uom"]');          // ðŸ”¹ new
        const qtyInput  = row.querySelector('input[name$="-quantity"]');
        const priceInput = row.querySelector('input[name$="-unit_price"]');
        const taxInput   = row.querySelector('input[name$="-tax_percent"]');
        const lineTotalEl = row.querySelector('.line-total');
        if(!lineTotalEl) return;

        const uom   = toDecimal(uomInput ? uomInput.value : 1);
        const qty   = toDecimal(qtyInput ? qtyInput.value : 0);
        const price = toDecimal(priceInput ? priceInput.value : 0);
        const taxPct = toDecimal(taxInput ? taxInput.value : 0);

        if (!uom && !qty && !price && !taxPct) {
          // completely empty row -> ignore in totals
          if (lineTotalEl.tagName.toLowerCase() === 'input') {
            lineTotalEl.value = "0.00";
          } else {
            lineTotalEl.textContent = "0.00";
          }
          return;
        }

        // ðŸ”¹ line_total = uom * qty * unit_price
        const line = parseFloat(round2(uom * qty * price));
        const taxAmount = parseFloat(round2(line * (taxPct / 100)));
        const cgst = parseFloat(round2(taxAmount / 2));
        const sgst = parseFloat(round2(taxAmount - cgst));

        if(lineTotalEl.tagName.toLowerCase() === 'input'){
          lineTotalEl.value = round2(line);
        } else {
          lineTotalEl.textContent = round2(line);
        }

        if(taxPct > 0){ 
          subtotal_taxable += line; 
        } else { 
          subtotal_exempt += line; 
        }
        cgst_total += cgst; 
        sgst_total += sgst; 
        grand_total += line + taxAmount;
      });

      document.getElementById('subtotal-taxable').textContent = round2(subtotal_taxable);
      document.getElementById('subtotal-exempt').textContent = round2(subtotal_exempt);
      document.getElementById('cgst-total').textContent = round2(cgst_total);
      document.getElementById('sgst-total').textContent = round2(sgst_total);
      document.getElementById('grand-total').textContent = round2(grand_total);

      const amtPaidEl = document.getElementById('id_amount_paid');
      const amountPaid = toDecimal(amtPaidEl ? amtPaidEl.value : 0);
      const remaining = Math.max(0, grand_total - amountPaid);
      
      document.getElementById('display-amount-paid').textContent = round2(amountPaid);
      document.getElementById('remaining-amount').textContent = round2(remaining);

      // Auto-update status only if user hasn't manually changed it
      const statusEl = document.getElementById('id_status');
      if(statusEl && !statusEl.dataset.userChanged){
        if(amountPaid >= grand_total && grand_total > 0) {
          statusEl.value = 'paid';
        } else if(amountPaid > 0) {
          statusEl.value = 'partial';
        } else {
          statusEl.value = 'pending';
        }
      }
    }

    function productChanged(selectEl){
      const productId = selectEl.value;
      const row = selectEl.closest('tr');
      const priceInput = row.querySelector('input[name$="-unit_price"]');
      const qtyInput = row.querySelector('input[name$="-quantity"]');
      const p = PRODUCTS && PRODUCTS.find(x => String(x.id) === String(productId));
      if(p && priceInput){ 
        priceInput.value = p.price_per_unit || p.price || ''; 
      }
      else if(priceInput){ 
        priceInput.value = ''; 
      }
      if(qtyInput && (!qtyInput.value || Number(qtyInput.value) === 0)) {
        qtyInput.value = 1;
      }
      recalcAll();
    }

    // Initialize customer details on page load
    function initCustomerDetails() {
      const customerSelect = document.getElementById('id_customer');
      if (customerSelect && customerSelect.value) {
        fetchCustomerDetails(customerSelect.value);
      }
    }

    function fetchCustomerDetails(custId) {
      if(!custId){
        document.getElementById('customer-details').style.display = 'none';
        return;
      }
      
      fetch(`{% url 'sales:customer_detail_json' 0 %}`.replace('/0/', `/${custId}/`))
        .then(resp => resp.json())
        .then(data => {
          if(data.ok && data.customer){
            const detailsEl = document.getElementById('customer-details');
            detailsEl.style.display = 'block';
            document.getElementById('cust-name').textContent = data.customer.name;
            document.getElementById('cust-phone').textContent = data.customer.phone ? ('Phone: ' + data.customer.phone) : '';
            document.getElementById('cust-email').textContent = data.customer.email ? ('Email: ' + data.customer.email) : '';
            document.getElementById('cust-address').textContent = data.customer.address ? ('Address: ' + data.customer.address) : '';
          } else {
            document.getElementById('customer-details').style.display = 'none';
          }
        }).catch(err => {
          console.error('Customer fetch error', err);
          document.getElementById('customer-details').style.display = 'none';
        });
    }

    // ðŸ”¹ Add new row using empty_form template
    function addNewRow() {
      const info = getFormsetInfo();
      if (!info) {
        console.warn("TOTAL_FORMS not found for formset");
        return;
      }
      const { totalFormsEl } = info;
      const formCount = parseInt(totalFormsEl.value || '0', 10);

      const template = document.getElementById('empty-form-row');
      if (!template) {
        console.warn("empty-form-row template not found");
        return;
      }

      const tbody = document.getElementById('items-tbody');
      const newRow = template.cloneNode(true);
      newRow.id = '';
      newRow.classList.remove('d-none');

      // Replace __prefix__ with new index in names & ids
      newRow.innerHTML = newRow.innerHTML.replace(/__prefix__/g, formCount);

      tbody.appendChild(newRow);
      totalFormsEl.value = formCount + 1;
      recalcAll();
    }

    // Global delegated listeners (safe to attach anytime)
    document.addEventListener('change', function(e){
      // Product select change
      if(e.target.matches('select[name$="-product"]')) {
        productChanged(e.target);
      }

      // Customer select change
      if(e.target.matches('#id_customer')){
        fetchCustomerDetails(e.target.value);
      }

      // Quantity, price, tax changes
      if(e.target.matches('input[name$="-uom"], input[name$="-quantity"], input[name$="-unit_price"], input[name$="-tax_percent"]')) {
        recalcAll();
      }

      // Status manual change
      if(e.target.matches('#id_status')){
        e.target.dataset.userChanged = '1';
      }
    });

    document.addEventListener('input', function(e){
      if(e.target.matches('#id_amount_paid')) {
        recalcAll();
      }
    });

    document.addEventListener('click', function(e){
      // Remove row -> mark DELETE and hide
      if(e.target.matches('.remove-row')){
        const row = e.target.closest('tr');
        const deleteCheckbox = row.querySelector('input[name$="-DELETE"]');
        if (deleteCheckbox) {
          deleteCheckbox.checked = true;
        }
        row.style.display = 'none';
        recalcAll();
      }
    });

    // All DOM-dependent setup
    document.addEventListener('DOMContentLoaded', function(){
      const addRowBtn = document.getElementById('add-row');

      if(addRowBtn){
        addRowBtn.addEventListener('click', function(){
          addNewRow();
        });
      }

      // Initial totals
      recalcAll();
      initCustomerDetails();
    });

  })();
  </script>
{% endblock %}
