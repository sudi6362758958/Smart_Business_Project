{# templates/purchase/purchase_form.html #}
{% extends 'base.html' %}

{% block title %}
  {% if editing %}
    Edit Purchase
  {% else %}
    New Purchase
  {% endif %}
{% endblock %}

{% block content %}
  <div class="container py-4">
    <h3>
      {% if editing %}
        Edit Purchase
      {% else %}
        Create Purchase
      {% endif %}
    </h3>

    <form method="post">
      {% csrf_token %}
      {{ form.non_field_errors }}

      <style>
        /* Hide the DELETE checkbox, we will use a Remove button instead */
        input[type='checkbox'][name$='-DELETE'] {
          display: none;
        }
      </style>

      <div class="row mb-3">
        <div class="col-md-4">
          {{ form.business }}
          <label class="form-label">Business</label>
          <div class="form-control-plaintext">
            <strong>{{ business.name }}</strong>
          </div>
        </div>

        <div class="col-md-4">
          <label class="form-label" for="{{ form.supplier.id_for_label }}">{{ form.supplier.label }}</label>
          {{ form.supplier }}
          {% for err in form.supplier.errors %}
            <div class="text-danger small">{{ err }}</div>
          {% endfor %}

          <label class="form-label mt-2" for="{{ form.company.id_for_label }}">{{ form.company.label }}</label>
          {{ form.company }}
          {% for err in form.company.errors %}
            <div class="text-danger small">{{ err }}</div>
          {% endfor %}

          <label class="form-label mt-2" for="{{ form.phone.id_for_label }}">{{ form.phone.label }}</label>
          {{ form.phone }}
          {% for err in form.phone.errors %}
            <div class="text-danger small">{{ err }}</div>
          {% endfor %}
        </div>

        <div class="col-md-2">
          <label class="form-label" for="{{ form.date.id_for_label }}">{{ form.date.label }}</label>
          {{ form.date }}
          {% for err in form.date.errors %}
            <div class="text-danger small">{{ err }}</div>
          {% endfor %}
        </div>

        <div class="col-md-2">
          <label class="form-label" for="{{ form.total.id_for_label }}">{{ form.total.label }}</label>
          {{ form.total }}
          {% for err in form.total.errors %}
            <div class="text-danger small">{{ err }}</div>
          {% endfor %}
        </div>
      </div>

      <h5 class="mt-3">Items</h5>

      {{ formset.management_form }}

      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Product</th>
            <th style="width:140px">Quantity (base unit)</th>
            <th style="width:140px">Unit Cost</th>
            <th style="width:80px">Remove</th>
          </tr>
        </thead>
        <tbody id="item-rows">
          {% for f in formset %}
            <tr class="item-form-row">
              {# IMPORTANT: explicitly include the hidden id field so it is posted back #}
              {{ f.id }}
              <td>
                {{ f.product }}
                {% for err in f.product.errors %}
                  <div class="text-danger small">{{ err }}</div>
                {% endfor %}
              </td>
              <td>
                {{ f.quantity }}
                {% for err in f.quantity.errors %}
                  <div class="text-danger small">{{ err }}</div>
                {% endfor %}
              </td>
              <td>
                {{ f.unit_cost }}
                {% for err in f.unit_cost.errors %}
                  <div class="text-danger small">{{ err }}</div>
                {% endfor %}
              </td>
              <td class="text-center">
                {{ f.DELETE }}
                <button type="button" class="btn btn-danger btn-sm remove-row">ðŸ—‘ Remove</button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Add Item button -->
      <div class="mb-3">
        <button type="button" id="add-row" class="btn btn-outline-success btn-sm">+ Add Item</button>
      </div>

      <!-- Hidden template for a new row (uses formset.empty_form).
           Include empty_form.id so the __prefix__ id hidden input exists. -->
      <script type="text/template" id="empty-form-template">
        <tr class="item-form-row">
          {{ formset.empty_form.id }}
          <td>
            {{ formset.empty_form.product }}
          </td>
          <td>
            {{ formset.empty_form.quantity }}
          </td>
          <td>
            {{ formset.empty_form.unit_cost }}
          </td>
          <td class="text-center">
            {{ formset.empty_form.DELETE }}
            <button type="button" class="btn btn-danger btn-sm remove-row">
              ðŸ—‘ Remove
            </button>
          </td>
        </tr>
      </script>

      <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-primary">Save Purchase</button>
        <a href="{% url 'purchases:purchase_list' %}" class="btn btn-secondary">Cancel</a>
      </div>

      <script>
        document.addEventListener("DOMContentLoaded", function () {
          const itemRowsContainer = document.getElementById("item-rows");
          const addRowBtn = document.getElementById("add-row");

          // Management form TOTAL_FORMS input (Django renders this)
          const totalFormsInput = document.querySelector(
            'input[name="{{ formset.management_form.TOTAL_FORMS.html_name }}"]'
          );

          let totalForms = parseInt(totalFormsInput.value, 10) || 0;

          // Function to attach remove handler to buttons
          function attachRemoveHandlers(scope) {
            (scope || document).querySelectorAll(".remove-row").forEach(function (btn) {
              if (btn.dataset.bound === "true") return;
              btn.dataset.bound = "true";

              btn.addEventListener("click", function () {
                const row = btn.closest("tr");
                if (!row) return;

                // Find DELETE checkbox in this row
                const deleteCheckbox = row.querySelector(
                  "input[type='checkbox'][name$='-DELETE']"
                );

                if (deleteCheckbox) {
                  deleteCheckbox.checked = true; // mark for deletion
                }

                // Hide the row visually
                row.style.display = "none";
              });
            });
          }

          // Initially attach remove handlers to existing rows
          attachRemoveHandlers(itemRowsContainer);

          // Add new row using empty_form template
          addRowBtn.addEventListener("click", function () {
            const templateHtml = document
              .getElementById("empty-form-template")
              .innerHTML.trim();

            // Replace __prefix__ in the empty_form fields with the new index
            const newRowHtml = templateHtml.replace(/__prefix__/g, totalForms);

            // Convert HTML string to actual DOM node
            const tempContainer = document.createElement("tbody");
            tempContainer.innerHTML = newRowHtml;
            const newRow = tempContainer.querySelector("tr");

            // Clear any prefilled values inside newRow (important: make empty_form truly empty)
            newRow.querySelectorAll("input, select, textarea").forEach(function (el) {
              // Skip hidden inputs like management fields and the id hidden field
              if (el.type === "hidden") return;

              // For selects set to the first option (usually the blank option)
              if (el.tagName.toLowerCase() === "select") {
                el.selectedIndex = 0;
              } else {
                el.value = "";
              }
            });

            // Optionally set a default quantity for user convenience (remove this line to keep empty)
            const qtyInput = newRow.querySelector("input[name$='-quantity']");
            if (qtyInput) {
              qtyInput.value = "1";
            }

            // Append to table body
            itemRowsContainer.appendChild(newRow);

            // Increase TOTAL_FORMS count for Django formset
            totalForms += 1;
            totalFormsInput.value = totalForms.toString();

            // Attach remove handler to this new row
            attachRemoveHandlers(newRow);
          });
        });
      </script>
    </form>
  </div>
{% endblock %}
