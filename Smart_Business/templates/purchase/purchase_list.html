{% extends 'base.html' %}
{% load static %}
{% block title %}Purchases{% endblock %}

{% block content %}
<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">Purchases for {{ business.name }}</h4>
    <a href="{% url 'purchases:purchase_create' %}" class="btn btn-primary">+ New Purchase</a>
  </div>
  <hr>

  <!-- Filters: single search (supplier/company/product), date range, per_page.
       Buttons aligned to the right. -->
  <form id="filtersForm" class="row g-2 align-items-center mb-3" method="get">
    <div class="col-md-5">
      <input type="text" name="q" value="{{ request.GET.q|default:'' }}" class="form-control" placeholder="Search supplier, company or product">
    </div>

    <div class="col-auto">
      <input type="date" name="date_from" value="{{ request.GET.date_from|default:'' }}" class="form-control" placeholder="From">
    </div>
    <div class="col-auto">
      <input type="date" name="date_to" value="{{ request.GET.date_to|default:'' }}" class="form-control" placeholder="To">
    </div>

    <div class="col-auto">
      <select name="per_page" id="per_page" class="form-select">
        <option value="10" {% if request.GET.per_page == '10' %}selected{% endif %}>10</option>
        <option value="25" {% if request.GET.per_page == '25' or not request.GET.per_page %}selected{% endif %}>25</option>
        <option value="50" {% if request.GET.per_page == '50' %}selected{% endif %}>50</option>
        <option value="100" {% if request.GET.per_page == '100' %}selected{% endif %}>100</option>
      </select>
    </div>

    <!-- spacer pushes buttons to right -->
    <div class="col"></div>

    <div class="col-auto d-flex gap-2">
      <button type="submit" class="btn btn-primary">Filter</button>
      <a href="{% url 'purchases:purchase_list' %}" class="btn btn-outline-secondary">Reset</a>
    </div>
  </form>

  <!-- Selection toolbar -->
  <div id="selectionToolbar" class="d-none mb-2">
    <div class="d-flex align-items-center gap-2">
      <small id="selectedCount">0 selected</small>
      <button id="exportSelectedBtn" class="btn btn-sm btn-outline-success">Export Selected</button>
      <button id="clearSelectedBtn" class="btn btn-sm btn-outline-secondary">Clear</button>
    </div>
  </div>
  <hr>

  <!-- Table -->
  <div class="table-responsive">
    <table class="table table-striped" id="purchasesTable">
      <thead>
        <tr>
          <th style="width:36px;"><input id="selectAll" type="checkbox"></th>
          <th>#</th>
          <th>Date</th>
          <th>Supplier</th>
          <th>Company</th>
          <th>Product Name(s)</th>
          <th>Items (Qty × Unit Cost)</th>
          <th>Total</th>
          <th>Created</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for p in purchases %}
          <tr class="purchase-row" data-pk="{{ p.pk }}">
            <td><input class="rowCheckbox" type="checkbox" value="{{ p.pk }}"></td>
            <td>{{ p.pk }}</td>
            <td>{{ p.date }}</td>
            <td class="supplier-cell">{{ p.supplier }}</td>
            <td>{{ p.company }}</td>

            <td>
              {% if p.items.all %}
                {% for it in p.items.all %}
                  <div>{{ it.product.name }}</div>
                {% endfor %}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>

            <td>
              {% if p.items.all %}
                <ul class="mb-0 ps-3">
                  {% for it in p.items.all %}
                    <li>{{ it.quantity }} × {{ it.unit_cost }}</li>
                  {% endfor %}
                </ul>
              {% else %}
                <span class="text-muted">No items</span>
              {% endif %}
            </td>

            <td>{{ p.total }}</td>
            <td>{{ p.created_at|date:"Y-m-d H:i" }}</td>
            <td>
              <a class="btn btn-sm btn-info" href="{% url 'purchases:purchase_detail' p.pk %}">View</a>
              <a class="btn btn-sm btn-warning" href="{% url 'purchases:purchase_edit' p.pk %}">Edit</a>

              {% if p.pk %}
                <form action="{% url 'purchases:purchase_delete' p.pk %}" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this purchase?');">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="10" class="text-center text-muted">No purchases found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="d-flex justify-content-between align-items-center mt-2">
    <div>
      <p class="mb-0">Showing {{ page_obj.start_index }} - {{ page_obj.end_index }} of {{ page_obj.paginator.count }}</p>
    </div>
    <nav aria-label="Page navigation">
      <ul class="pagination mb-0" id="paginationList">
        {% if page_obj.has_previous %}
          <li class="page-item"><a href="#" class="page-link page-link-js" data-page="{{ page_obj.previous_page_number }}">Previous</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
          {% if num == page_obj.number %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% elif num <= page_obj.number|add:'2' and num >= page_obj.number|add:'-2' %}
            <li class="page-item"><a href="#" class="page-link page-link-js" data-page="{{ num }}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <li class="page-item"><a href="#" class="page-link page-link-js" data-page="{{ page_obj.next_page_number }}">Next</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
      </ul>
    </nav>
  </div>

</div>

<script>
// keep GET params when changing page/per_page and build export query
function buildQueryWith(params) {
  const urlParams = new URLSearchParams(window.location.search);
  for (const k in params) {
    if (params[k] === null) urlParams.delete(k);
    else urlParams.set(k, params[k]);
  }
  return urlParams.toString();
}

document.addEventListener('DOMContentLoaded', function() {
  const selectAll = document.getElementById('selectAll');
  const rowCheckboxes = Array.from(document.querySelectorAll('.rowCheckbox'));
  const toolbar = document.getElementById('selectionToolbar');
  const selectedCountEl = document.getElementById('selectedCount');
  const exportBtn = document.getElementById('exportSelectedBtn');
  const clearBtn = document.getElementById('clearSelectedBtn');

  function updateToolbar() {
    const checked = rowCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
    const count = checked.length;
    if (count > 0) {
      toolbar.classList.remove('d-none');
      selectedCountEl.textContent = `${count} selected`;
      const base = "{% url 'purchases:purchase_export' %}";
      exportBtn.onclick = function(e) {
        e.preventDefault();
        const ids = checked.join(',');
        const query = buildQueryWith({'ids': ids});
        window.open(base + '?' + query, '_blank');
      };
    } else {
      toolbar.classList.add('d-none');
      selectedCountEl.textContent = '0 selected';
      exportBtn.onclick = null;
    }
  }

  if (selectAll) {
    selectAll.addEventListener('change', function() {
      rowCheckboxes.forEach(cb => cb.checked = selectAll.checked);
      updateToolbar();
    });
  }

  rowCheckboxes.forEach(cb => {
    cb.addEventListener('change', function() {
      if (!this.checked && selectAll) selectAll.checked = false;
      else if (selectAll && rowCheckboxes.every(c => c.checked)) selectAll.checked = true;
      updateToolbar();
    });
  });

  clearBtn.addEventListener('click', function() {
    rowCheckboxes.forEach(cb => cb.checked = false);
    if (selectAll) selectAll.checked = false;
    updateToolbar();
  });

  // per_page change -> submit form reset to page 1
  const perPageEl = document.getElementById('per_page');
  if (perPageEl) {
    perPageEl.addEventListener('change', function() {
      const f = document.getElementById('filtersForm');
      const pageInput = document.createElement('input');
      pageInput.type = 'hidden'; pageInput.name = 'page'; pageInput.value = '1';
      f.appendChild(pageInput);
      f.submit();
    });
  }

  // pagination links
  document.querySelectorAll('.page-link-js').forEach(a => {
    a.addEventListener('click', function(e) {
      e.preventDefault();
      const page = this.dataset.page;
      const params = new URLSearchParams(window.location.search);
      params.set('page', page);
      window.location.search = params.toString();
    });
  });

});
</script>
{% endblock %}
