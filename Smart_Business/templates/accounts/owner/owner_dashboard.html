{% extends "base.html" %} 
{% block title %}
{{ business.name }} Dashboard{%endblock %} 
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h2>{{ business.name }} — Dashboard</h2>
      <p class="text-muted">
        Welcome {{ user.get_full_name|default:user.username }}
      </p>
    </div>
  </div>

  <!-- Today's summary cards (unchanged) -->
  <div class="row g-3 mt-3">
    <div class="col-md-3">
      <div class="card text-white bg-primary">
        <div class="card-body">
          <h6>Today's Sales</h6>
          <h3>₹ {{ today_sales }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-warning">
        <div class="card-body">
          <h6>Today's Purchases</h6>
          <h3>₹ {{ today_purchase }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-info">
        <div class="card-body">
          <h6>Today's Expenses</h6>
          <h3>₹ {{ today_expense }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-success">
        <div class="card-body">
          <h6>Today's Profit</h6>
          <h3>₹ {{ today_profit }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Date-range selector and export controls -->
  <div class="card mt-4 p-3">
    <div class="d-flex align-items-end gap-3">
      <div>
        <label class="form-label small mb-1">Start date</label>
        <input
          type="date"
          id="start_date"
          name="start_date"
          class="form-control"
          value="{{ start_date }}"
        />
      </div>
      <div>
        <label class="form-label small mb-1">End date</label>
        <input
          type="date"
          id="end_date"
          name="end_date"
          class="form-control"
          value="{{ end_date }}"
        />
      </div>

      <div class="align-self-end">
        <button id="applyRange" class="btn btn-primary">Apply & Preview</button>
      </div>

      <div class="ms-auto d-flex gap-2">
        <a
          id="exportPdfWeek"
          class="btn btn-outline-secondary btn-sm"
          href="{% url 'accounts:owner_dashboard_export_pdf' business.pk %}?period=week"
          >Export Week PDF</a
        >
        <a
          id="exportPdfMonth"
          class="btn btn-outline-secondary btn-sm"
          href="{% url 'accounts:owner_dashboard_export_pdf' business.pk %}?period=month"
          >Export Month PDF</a
        >
        <a id="exportPdfRange" class="btn btn-outline-secondary btn-sm" href="#"
          >Export Range PDF</a
        >
        <a id="exportCsvRange" class="btn btn-outline-success btn-sm" href="#"
          >Export Range CSV</a
        >
      </div>
    </div>

    <!-- preview table for custom range -->
    <div
      id="rangePreview"
      class="mt-3"
      style="display: {% if custom_rows %}block{% else %}none{% endif %};"
    >
      {% if custom_rows %}
      <h6>Preview for selected range</h6>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Date</th>
              <th class="text-end">Sales</th>
              <th class="text-end">Purchases</th>
              <th class="text-end">Expenses</th>
              <th class="text-end">Profit</th>
            </tr>
          </thead>
          <tbody>
            {% for r in custom_rows %}
            <tr>
              <td>{{ r.date }}</td>
              <td class="text-end">₹ {{ r.sales }}</td>
              <td class="text-end">₹ {{ r.purchases }}</td>
              <td class="text-end">₹ {{ r.expenses }}</td>
              <td class="text-end">₹ {{ r.profit }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Week and Month charts / cards (unchanged from earlier) -->
  <div class="card mt-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">This Week (daily)</h5>
      </div>
      <canvas id="weekChart" height="120"></canvas>
      <div class="d-flex gap-2 flex-wrap mt-3">
        {% for row in week_rows %}
        <div class="card p-2" style="min-width: 140px">
          <div class="small text-muted">{{ row.label }}</div>
          <div>Sales: ₹ {{ row.sales }}</div>
          <div>Purch: ₹ {{ row.purchases }}</div>
          <div>Exp: ₹ {{ row.expenses }}</div>
          <div class="fw-bold">P/L: ₹ {{ row.profit }}</div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="card mt-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">This Month (daywise)</h5>
      </div>
      <canvas id="monthChart" height="120"></canvas>
      <div
        class="d-flex gap-2 mt-3"
        style="overflow-x: auto; padding-bottom: 8px"
      >
        {% for row in month_rows %}
        <div class="card p-2 text-center" style="min-width: 110px">
          <div class="small text-muted">Day {{ row.day }}</div>
          <div>Sales ₹ {{ row.sales }}</div>
          <div>Purch ₹ {{ row.purchases }}</div>
          <div>Exp ₹ {{ row.expenses }}</div>
          <div class="fw-bold">P/L ₹ {{ row.profit }}</div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function () {
    // Charts same as before
    const weekLabels = {{ week_labels|safe }};
    const weekSales = {{ week_sales|safe }};
    const weekPurch = {{ week_purchases|safe }};
    const weekExp = {{ week_expenses|safe }};
    const weekProf = {{ week_profit|safe }};

    new Chart(document.getElementById('weekChart'), {
      type: 'line',
      data: {
        labels: weekLabels,
        datasets: [
          { label: 'Sales', data: weekSales, borderColor: '#0d6efd', tension: 0.3, fill:false },
          { label: 'Purchases', data: weekPurch, borderColor: '#ffc107', tension: 0.3, fill:false },
          { label: 'Expenses', data: weekExp, borderColor: '#0dcaf0', tension: 0.3, fill:false },
          { label: 'Profit', data: weekProf, borderColor: '#198754', tension: 0.3, fill:false }
        ]
      },
      options: { responsive: true, scales: { y: { beginAtZero:true } } }
    });

    const monthLabels = {{ month_labels|safe }};
    const monthSales = {{ month_sales|safe }};
    const monthPurch = {{ month_purchases|safe }};
    const monthExp = {{ month_expenses|safe }};
    const monthProf = {{ month_profit|safe }};

    new Chart(document.getElementById('monthChart'), {
      type: 'line',
      data: {
        labels: monthLabels,
        datasets: [
          { label: 'Sales', data: monthSales, borderColor: '#0d6efd', tension: 0.3, fill:false },
          { label: 'Purchases', data: monthPurch, borderColor: '#ffc107', tension: 0.3, fill:false },
          { label: 'Expenses', data: monthExp, borderColor: '#0dcaf0', tension: 0.3, fill:false },
          { label: 'Profit', data: monthProf, borderColor: '#198754', tension: 0.3, fill:false }
        ]
      },
      options: { responsive: true, scales: { y: { beginAtZero:true } } }
    });

    // Range preview & export handlers
    const applyBtn = document.getElementById('applyRange');
    const startEl = document.getElementById('start_date');
    const endEl = document.getElementById('end_date');
    const preview = document.getElementById('rangePreview');
    const exportPdfRange = document.getElementById('exportPdfRange');
    const exportCsvRange = document.getElementById('exportCsvRange');

    function buildRangeUrl(base, params) {
      const parts = [];
      for (const k in params) {
        if (params[k]) parts.push(encodeURIComponent(k) + '=' + encodeURIComponent(params[k]));
      }
      return base + (parts.length ? ('?' + parts.join('&')) : '');
    }

    applyBtn.addEventListener('click', function () {
      const s = startEl.value;
      const e = endEl.value;
      if (!s || !e) {
        alert('Select both start and end dates');
        return;
      }
      // reload page with params to show preview (server will compute custom_rows)
      const url = new URL(window.location.href);
      url.searchParams.set('start_date', s);
      url.searchParams.set('end_date', e);
      window.location = url.toString();
    });

    exportPdfRange.addEventListener('click', function (ev) {
      ev.preventDefault();
      const s = startEl.value;
      const e = endEl.value;
      if (!s || !e) { alert('Select start and end'); return; }
      const url = buildRangeUrl("{% url 'accounts:owner_dashboard_export_pdf' business.pk %}", { period: 'range', start_date: s, end_date: e });
      window.open(url, '_blank');
    });

    exportCsvRange.addEventListener('click', function (ev) {
      ev.preventDefault();
      const s = startEl.value;
      const e = endEl.value;
      if (!s || !e) { alert('Select start and end'); return; }
      const url = buildRangeUrl("{% url 'accounts:owner_dashboard_export_csv' business.pk %}", { period: 'range', start_date: s, end_date: e });
      window.open(url, '_blank');
    });

  })();
</script>
{% endblock %}
