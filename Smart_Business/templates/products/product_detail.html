{% extends 'base.html' %}
{% load static %}
{% block title %}{{ product.name }} - SmartBiz{% endblock %}

{% block content %}
<div class="card p-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">{{ product.name }}</h4>
    <small class="text-muted">Stock: {{ product.remaining_stock_display }}</small>
  </div>

  <div class="row">
    <div class="col-md-6">
      <p><strong>Category:</strong> {{ product.category }}</p>
      <p><strong>Base unit:</strong> {{ product.get_base_unit_display }}</p>
      <p><strong>Price per {{ product.base_unit }}:</strong> ₹{{ product.price_per_unit }}</p>
      <p><strong>Stock:</strong> {{ product.remaining_stock_display }}</p>
    </div>

    <div class="col-md-6">
      <form id="price-calc-form" class="card card-body">
        <input type="hidden" name="product_id" id="pc-product-id" value="{{ product.pk }}" />

        <div class="mb-2">
          <label for="pc-quantity" class="form-label">Quantity</label>
          <input id="pc-quantity" name="quantity" type="number" step="0.001" min="0.001"
                 value="1" class="form-control" />
        </div>

        <div class="mb-2">
          <label for="pc-unit" class="form-label">Unit</label>
          <select id="pc-unit" name="unit" class="form-select">
            {% for val, label in product.UNIT_CHOICES %}
              <option value="{{ val }}" {% if product.base_unit == val %}selected{% endif %}>
                {{ label }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-2 d-flex gap-2">
          <button type="button" id="pc-calc-btn" class="btn btn-outline-primary">Calculate Price</button>
          <a href="{% url 'sales:invoice_create' %}" class="btn btn-primary">Add to Cart</a>
        </div>

        <div id="pc-result" class="mt-2">
          <strong>Total:</strong> <span id="pc-total">—</span>
          <div id="pc-error" class="text-danger small mt-1" style="display:none;"></div>
        </div>
      </form>
    </div>
  </div>
</div>

{# Include static JS (recommended) #}
<script src="{% static 'products/price_calc.js' %}"></script>

{# Inline fallback if you prefer not to use separate static file.
   (You can remove this block if using the external JS file above.) #}
<script>
/* Fallback inline script — remove this if you use static/products/price_calc.js */
(function(){
  function getCookie(name) {
    const cookies = document.cookie ? document.cookie.split(';') : [];
    for (let i = 0; i < cookies.length; i++) {
      const c = cookies[i].trim();
      if (c.startsWith(name + '=')) {
        return decodeURIComponent(c.substring(name.length + 1));
      }
    }
    return null;
  }
  const csrftoken = getCookie('csrftoken');

  function debounce(fn, wait) {
    let t;
    return function(...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  async function callApi(productId, quantity, unit) {
    const params = new URLSearchParams();
    params.append('product_id', productId);
    params.append('quantity', quantity);
    params.append('unit', unit);

    const resp = await fetch("{% url 'products:price_calculator_api' %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: params.toString()
    });

    const data = await resp.json();
    return { resp, data };
  }

  document.addEventListener('DOMContentLoaded', function () {
    const productId = document.getElementById('pc-product-id').value;
    const qtyInput = document.getElementById('pc-quantity');
    const unitSelect = document.getElementById('pc-unit');
    const resultSpan = document.getElementById('pc-total');
    const errorDiv = document.getElementById('pc-error');
    const calcBtn = document.getElementById('pc-calc-btn');

    async function updatePrice() {
      errorDiv.style.display = 'none';
      resultSpan.textContent = 'Calculating...';
      try {
        const quantity = qtyInput.value;
        const unit = unitSelect.value;

        if (!quantity || parseFloat(quantity) <= 0) {
          resultSpan.textContent = 'Enter valid quantity';
          return;
        }

        const { resp, data } = await callApi(productId, quantity, unit);
        if (!resp.ok) {
          const firstErr = data && data.errors ? Object.values(data.errors)[0] : null;
          const msg = Array.isArray(firstErr) ? firstErr[0] : (firstErr || 'Error');
          errorDiv.style.display = 'block';
          errorDiv.textContent = msg;
          resultSpan.textContent = '—';
          return;
        }

        if (data.ok) {
          resultSpan.textContent = '₹' + data.total;
        } else {
          resultSpan.textContent = '—';
        }
      } catch (err) {
        console.error(err);
        errorDiv.style.display = 'block';
        errorDiv.textContent = 'Network error';
        resultSpan.textContent = '—';
      }
    }

    const debouncedUpdate = debounce(updatePrice, 300);
    qtyInput.addEventListener('input', debouncedUpdate);
    unitSelect.addEventListener('change', debouncedUpdate);
    calcBtn.addEventListener('click', updatePrice);

    // initial calculation
    debouncedUpdate();
  });
})();
</script>
{% endblock %}
