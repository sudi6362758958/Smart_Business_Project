{% extends 'base.html' %}
{% load static %}
{% block title %}Products - SmartBiz{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h4 class="m-0">Products for {% if business %}{{ business.name }}{% else %}—{% endif %}</h4>
    {% if business %}
      <small class="text-muted">Business ID: {{ business.pk }}</small>
    {% endif %}
  </div>

  <div class="d-flex gap-2">  
    <a href="{% url 'products:product_create' %}" class="btn btn-primary">+ Add Product</a>
  </div>
</div>

<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Name</th>
            <th>Category</th>
            <th>Base unit</th>
            <th>Price / unit</th>
            <th>Stock</th>
            <th>Low stock</th>
            <th style="min-width: 320px;">Quick calculator</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
            <tr data-product-id="{{ product.pk }}">
              <td>{{ product.name }}</td>
              <td>{% if product.category %}{{ product.category }}{% else %}-{% endif %}</td>
              <td>{{ product.get_base_unit_display }}</td>
              <td>₹{{ product.price_per_unit }}</td>
              <td>{{ product.remaining_stock_display }}</td>
              <td>
                {% if product.is_low_stock %}
                  <span class="badge bg-warning text-dark">Low</span>
                {% else %}
                  <span class="text-muted">OK</span>
                {% endif %}
              </td>

              <!-- Quick calculator column (inline per-row form) -->
              <td>
                <form class="quick-calc-form d-flex flex-wrap gap-2 align-items-center" onsubmit="return false;">
                  <input type="hidden" name="product_id" class="qc-product-id" value="{{ product.pk }}">

                  <div class="input-group" style="width:140px;">
                    <span class="input-group-text">Qty</span>
                    <input type="number" name="quantity" class="form-control qc-quantity" step="0.001" min="0.001" value="1" />
                  </div>

                  <div style="width:140px;">
                    <select name="unit" class="form-select qc-unit">
                      {% for val,label in product.UNIT_CHOICES %}
                        <option value="{{ val }}" {% if product.base_unit == val %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
                  </div>

                  <button type="button" class="btn btn-outline-primary btn-sm qc-calc-btn">Calculate</button>

                  <div class="ms-2 qc-result" style="min-width:120px;">
                    <div><strong>Total:</strong> <span class="qc-total">—</span></div>
                    <div class="qc-error text-danger small" style="display:none;"></div>
                  </div>
                </form>
              </td>

              <td>
                <a href="{% url 'products:product_detail' product.pk %}" class="btn btn-sm btn-outline-secondary">View</a>
                <form action="{% url 'products:product_delete' product.pk %}" method="post" class="d-inline">{% csrf_token %}<button type="submit" 
                  class="btn btn-sm btn-outline-danger"
                  onclick="return confirm('Are you sure you want to delete {{ product.name }}?');"> Delete</button>
                </form>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="8" class="text-center py-4 text-muted">No products found.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{# Inline JS to handle multiple per-row calculators. Use CSRF cookie. #}
<script>
/* products/product_list.html - inline JS for quick per-row price calculation */

(function () {
  // CSRF cookie helper (default Django name)
  function getCookie(name) {
    const cookies = document.cookie ? document.cookie.split(';') : [];
    for (let i = 0; i < cookies.length; i++) {
      const c = cookies[i].trim();
      if (c.startsWith(name + '=')) {
        return decodeURIComponent(c.substring(name.length + 1));
      }
    }
    return null;
  }
  const csrftoken = getCookie('csrftoken');

  // Helper to post form-encoded data
  async function postForm(url, data) {
    const body = new URLSearchParams();
    for (const [k, v] of Object.entries(data)) {
      body.append(k, v);
    }
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: body.toString()
    });
    const json = await resp.json().catch(() => null);
    return { resp, json };
  }

  // Select all rows that have a quick calc form
  document.addEventListener('DOMContentLoaded', function () {
    const apiUrl = "{% url 'products:price_calculator_api' %}";
    const rows = document.querySelectorAll('tr[data-product-id]');

    rows.forEach(row => {
      const form = row.querySelector('.quick-calc-form');
      if (!form) return;

      const productIdEl = form.querySelector('.qc-product-id');
      const qtyInput = form.querySelector('.qc-quantity');
      const unitSelect = form.querySelector('.qc-unit');
      const calcBtn = form.querySelector('.qc-calc-btn');
      const totalSpan = form.querySelector('.qc-total');
      const errorDiv = form.querySelector('.qc-error');

      // helper to update UI
      function showResult(text) {
        errorDiv.style.display = 'none';
        totalSpan.textContent = text;
      }
      function showError(text) {
        errorDiv.style.display = 'block';
        errorDiv.textContent = text;
        totalSpan.textContent = '—';
      }

      // Click handler
      calcBtn.addEventListener('click', async function () {
        errorDiv.style.display = 'none';
        totalSpan.textContent = 'Calculating...';

        const product_id = productIdEl.value;
        const quantity = qtyInput.value;
        const unit = unitSelect.value;

        if (!quantity || Number(quantity) <= 0) {
          showError('Enter valid quantity');
          return;
        }

        const { resp, json } = await postForm(apiUrl, {
          product_id: product_id,
          quantity: quantity,
          unit: unit
        });

        if (!resp) {
          showError('Network error');
          return;
        }

        if (!resp.ok) {
          // show first error message if available
          if (json && json.errors) {
            const first = Object.values(json.errors)[0];
            const msg = Array.isArray(first) ? first[0] : first;
            showError(msg || 'Error');
          } else {
            showError('Error calculating price');
          }
          return;
        }

        if (json && json.ok) {
          showResult('₹' + json.total);
        } else {
          showError('Could not calculate');
        }
      });

      // Optional: live calculation on quantity change with small debounce
      let timer = null;
      qtyInput.addEventListener('input', function () {
        clearTimeout(timer);
        timer = setTimeout(() => calcBtn.click(), 300);
      });
      unitSelect.addEventListener('change', function () {
        clearTimeout(timer);
        timer = setTimeout(() => calcBtn.click(), 100);
      });

      // initial calculate for convenience
      calcBtn.click();
    });
  });
})();
</script>
{% endblock %}
